var http = require('http');
var path_module = require('path');
var fs = require('fs');



module.exports = function (path, log) {
    var module = {};

    //settings
    var cb = null;
    var module_path = path_module.resolve('./node_modules');
    var beacons = loadModules(module_path, 'beacon-', 'mac');
    module.name = "webserver";
	module.port = process.env.PORT || 1337;




    module.start = function(callback) {
    	cb = callback;
    	webserver.listen(module.port);
    };


    module.stop = function(callback) {
    	webserver.close();
    };




	var webserver = http.createServer(function(req, res) {
		var url = req.url;
		log('webserver', url);

		if (url.match(/\/favicon.ico.*/gi)) {
			console.log("  [*] Serving favicon.ico");

			/*res.writeHead(200, {
				'Content-Type': 'image/png'
			});

			var stream = lib_fs.createReadStream("favicon.png");
			stream.pipe(res);*/
			res.end('', 404);
		}
		
		//serve robots.txt file
		else if (url.match(/\/robots.txt.*/gi)) {

			//send response code and headers
			res.writeHead(200, {
				'Content-Type': 'text/plain',
				'Cache-Control': 'no-cache'
			});

			res.end(' ');
		}

		else if (url.match(/((?:[\dA-Fa-f]{2}\:){5}(?:[\dA-Fa-f]{2}))/gi)) {
			var matches = /((?:[\dA-Fa-f]{2}\:){5}(?:[\dA-Fa-f]{2}))/.exec(url);
	        if (matches != null && matches.length > 0) {
	            if (cb != null) {
	            	cb(module.name, matches[1]);
	        	}
	        }

	        res.end(url);
		}
		
		
		//return main page
		else {	
			res.writeHead(200, {
				'Content-Type': 'text/html',
				'Cache-Control': 'no-cache'
			});
			
			//var page = fs.readFileSync("main.html", "utf8");
			var page = "<html><head></head><body><table><tr><td>MAC Address</td><td>Beacon Name</td></td>";
			for (beacon in beacons) {
				beacon = beacons[beacon];

				page += "<tr><td>" + beacon.mac + "</td><td>" + beacon.name + "</td></tr>";
			}

			page += "</table></html>";

			//return page
			res.end(page);
		}
	});

	function loadModules(base, prefix, index) {
		var ret = {};

		//check base dir
		if (fs.lstatSync(base).isDirectory() == true) {
			var dirs = fs.readdirSync(base);
			for (subdir in dirs) {
				if (dirs[subdir].substring(0,prefix.length).indexOf(prefix) !== -1) {
					//load modules from sub dirs with prefix
					var path = path_module.join(base, dirs[subdir]);
					if (fs.lstatSync(path).isDirectory() == true) {
						var files = fs.readdirSync(path);

						for (file in files) {
							file = files[file];

							//only loading .js files
							if (file.indexOf('.js', file.length - 3) !== -1) {
								var full = path_module.join(path, file);
								var module = require(full)(full, log);
								if (module != null) { 
									ret[module[index].toLowerCase()] = module;
			}}}}}}}
		return ret;
	}



    return module;
}